<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>databutton</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script type="text/javascript">
      const firebaseConfig = {
        apiKey: "AIzaSyAdgR9BGfQrV2fzndXZLZYgiRtpydlq8ug",
        authDomain: "databutton.firebaseapp.com",
        projectId: "databutton",
        storageBucket: "databutton.appspot.com",
        messagingSenderId: "89950862312",
        appId: "1:89950862312:web:13c6e744d43563e84d025d",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
    <!-- *******************************************************************************************
       * TODO(DEVELOPER): Paste the initialization snippet from this dialog box:
       * Firebase Console > Project Settings > Add App > Web.
       ***************************************************************************************** -->
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css"
    />
    <script type="text/javascript">
      // FirebaseUI config.
      var uiConfig = {
        signInOptions: [
          // Leave the lines as is for the providers you want to offer your users.
          firebase.auth.GoogleAuthProvider.PROVIDER_ID,
        ],
      };
      initApp = function () {
        firebase.auth().onAuthStateChanged(
          async function (user) {
            if (user) {
              // User is signed in.
              const refreshToken = user.refreshToken;
              try {
                await fetch("/success", {
                  method: "POST",
                  headers: {
                    "content-type": "application/json",
                  },
                  body: JSON.stringify({ refreshToken, uid: user.uid }),
                });
                document.getElementById(
                  "firebaseui-auth-container"
                ).innerHTML = `<p>Successfully logged in as ${user.displayName}!</p><p>Closing page...</p>`;
                setTimeout(() => {
                  window.close();
                }, 3000);
              } catch (ex) {
                document.getElementById(
                  "firebaseui-auth-container"
                ).innerHtml = `<p>Could not log you in. <a href="https://next.databutton.com/login?next=http://localhost:8008">Click here to try again</p>;`;
              }
            }
          },
          function (error) {
            console.log(error);
          }
        );
      };

      window.addEventListener("load", function () {
        initApp();
      });
    </script>
  </head>
  <body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h1>Databutton auth</h1>
    <div id="firebaseui-auth-container"></div>
  </body>
</html>
